<!DOCTYPE html>
<html>
<head>
  <style>
    table, th, td {
        border: 1px solid black;
        text-align: center;
    }
    table {
      table-layout: fixed;
    }
    td {
     width:   50px;
     height:  50px;
    }
  </style>


</head>
<body>
  <div id="loginUI">
    Username <input id="username" type="text"/><br>
    Password <input id="password" type="password"/><br>
    <button id="submitId">Go!</button>
    <p id="loginMsg"></p>
  </div>

  <p id="loginStatus">Not logged in</p>

  <div id="gameListUI">
    <p>Select a game or start a new one</p>
    <!-- TODO: list all available games to this player, including ones that
    haven't started yet and are looking for additional players' -->
    <ul id="gameListUL">

    </ul>
    <button id="startNewGame">Start new game</button>
  </div>

  <div id="boardUI">
    <p>Tic-Tac-Toe</p>
    <p>Click a square</p>
    <!-- TODO Let the user know his opponent and who is X and O -->

    <table class="boardStyle" style="width:100px">
      <tr>
        <td class="cell" r=0 c=0><p id="cell00"></p></td>
        <td class="cell" r=0 c=1><p id="cell01"></p></td>
        <td class="cell" r=0 c=2><p id="cell02"></p></td>
      </tr>
      <tr>
        <td class="cell" r=1 c=0><p id="cell10"></p></td>
        <td class="cell" r=1 c=1><p id="cell11"></p></td>
        <td class="cell" r=1 c=2><p id="cell12"></p></td>
      </tr>
      <tr>
        <td class="cell" r=2 c=0><p id="cell20"></p></td>
        <td class="cell" r=2 c=1><p id="cell21"></p></td>
        <td class="cell" r=2 c=2><p id="cell22"></p></td>
      </tr>
    <table>   
    
    <p id="winner"></p>
    
    <button id="reset">Reset</button>
  </div>

  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    var socket = io();

    $("#boardUI").hide();
    $("#gameListUI").hide();

    $("#submitId").click(function(){
      var loginInfo = { user: $("#username").val(), password: $("#password").val() };
      socket.emit('login', loginInfo);
    });

    $("#startNewGame").click(function() {
      socket.emit('startNewGame');
    });

    $("#reset").click(function(){
      socket.emit('resetBoard');
    });

    $(".cell").click(function(){
      var rc = {row: parseInt($(this).attr("r")) , col: parseInt($(this).attr("c")) };
      socket.emit('clickedSquare', rc);
    });

    $(".joinGame").click( function() {
      socket.emit('joinGame', $(this).attr("gameId") );
    });

    socket.on('serverUpdateBoard', function(msg) {
      updateBoard(msg);
    });

    socket.on('loginResponse', function(msg) {
      if( msg.success == true ) {
        $("#loginStatus").html("Logged in as " + msg.username);
        $("#loginMsg").html("");
        $("#loginUI").hide();

        socket.emit('requestGameList');
      }
      else {
        $("#loginStatus").html("Not logged in");
        $("#loginMsg").html("Invalid password");
      }
    });

    socket.on('updateGameList', function(msg) {
      $("#gameListUL").empty();

      var nbGames = msg.length;
      for( i = 0; i < nbGames; ++i ){
        var liStr = "<li>Game #";
        liStr += msg[i].gameId + ": , ";
        liStr += msg[i].user0;
        if( msg[i].user1 != null ) {
          liStr += ", " + msg[i].user1;
          liStr += " <button class='joinGame' gameId=";
          liStr += msg[i].gameId;
          liStr += " >Continue this game</button>";
        }
        else {
          liStr += ", waiting for another player. ";
          liStr += "<button class='joinGame' gameId=";
          liStr += msg[i].gameId;
          liStr += " >Join game</button>";
        }

        liStr += "</li>";  
        $("#gameListUL").append( liStr );
      }

      $("#gameListUI").show();
    });

    socket.on('startGame', function(msg) {
      $("#gameListUI").hide();

      updateBoard(msg);

      $("#gameBoardUI").show();
    });

    function updateBoard(gameBoard){
      for(r = 0; r < 3; r++){
        for(c = 0; c < 3; c++){
          if( gameBoard.data[r*3 + c] == 0 )
            $("#cell" + r + c).html("X");
          else if( gameBoard.data[r*3 + c] == 1 )
            $("#cell" + r + c).html("O");
          else
            $("#cell" + r + c).html("");
        }
      }

      if( gameBoard.gameOver ) {
        var winner = "Game Over! ";
        switch( gameBoard.winner ) {
          case 0: winner += "X Wins!"; break;
          case 1: winner += "O Wins!"; break;
          default: winner += "Cat's game!"; break;
        }

        $("#winner").html( winner );
      }
      else {
        $("#winner").html("");
      }
    }
  </script>

</body>
</html>

